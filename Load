-- Load Character Rewrite
-- AlreadyPro
-- December 18, 2017

local InsertService = game:GetService("InsertService")
local RunService = game:GetService("RunService")

local button	= plugin:CreateToolbar("AlreadyPro's Plugins"):CreateButton("Load Character", "", "rbxassetid://753045508")

local LoadCharacter = require(script:WaitForChild("LoadCharacterModule"))


local isActive	= false
local origin		= plugin:GetSetting("SpawnOrigin") or false

local gui				= script.Parent:WaitForChild("CharacterGui")
local main			= gui:WaitForChild("Main")
local exit			= main:WaitForChild("Exit")
local content		= main:WaitForChild("Container")
local spawnbtns	= content:WaitForChild("SpawnButtons")
local R6		= spawnbtns:WaitForChild("SpawnCharacterR6")
local R15	= spawnbtns:WaitForChild("SpawnCharacterR6")
local spawnorigin	= content:WaitForChild("SpawnAtOrigin")
local user			= content:WaitForChild("User"):WaitForChild("TextBox")
local charImg		= content:WaitForChild("Character")

gui.Parent = game:GetService("CoreGui")

user.Changed:Connect(function(prop)
	if prop == "Text" and user.Text:len() >= 3 then
		pcall(function()
			charImg.Image = "https://www.roblox.com/bust-thumbnail/image?userId="..game.Players:GetUserIdFromNameAsync(user.Text).."&width=420&height=420&format=png"
		end)
	end
end)

for _,btn in next, spawnbtns:GetChildren() do
	if btn:IsA("TextButton") then
		local morph = btn.Name:match("SpawnCharacter(.+)")
		
		btn.MouseButton1Click:Connect(function()
			local camera = workspace.CurrentCamera or Instance.new("Camera", workspace)
			--local chr
			local success,chr = pcall(function()
				return LoadCharacter(user.Text, workspace, morph == "R15" and true or false)
			end)
			if not success then
				warn("[Load Character] An error occurred.")
			else
				chr:MoveTo((origin and Vector3.new(0,0,0)) or (camera.CFrame + (camera.CFrame.lookVector*15)).p)
				game.Selection:Set({chr})
			end
		end)
	end
end

spawnorigin.Check.Text = origin and "X" or ""

spawnorigin.MouseButton1Click:Connect(function()
	origin = not origin
	spawnorigin.Check.Text = origin and "X" or ""
end)

local function ButtonClicked()
	isActive = not isActive
	plugin:SetSetting("SpawnOrigin", origin)
	button:SetActive(isActive)
	main.Visible = isActive
	if not isActive then
		user.Text = "AlreadyPro"
		charImg.Image = "https://www.roblox.com/bust-thumbnail/image?userId=24243319&width=420&height=420&format=png"
	end
end

exit.MouseButton1Click:Connect(ButtonClicked)
button.Click:Connect(ButtonClicked)
